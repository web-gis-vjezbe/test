<!DOCTYPE html>
<html>
<head>
	<title>Geo-pretraživanje u stvarnom vremenu</title>


<meta charset="UTF-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">


<style>
body {
  font-family: tahoma;
}
</style>

<style>

.inp {
  font-size: 20px;
}

.map {
  width: 99vw;
  height: 99vh;
}

.results {
  position: absolute;
  top: 20px;
  left: 60px;
  font-size: 20px;
  z-index: 1;
  background-color: rgba(200,200,200,.9);
  width: 300px;
  height: 200px;
  border-radius: 15px;
overflow: auto; 
}

.topleftdata {
  position: absolute;
  top: 250px;
  left: 15px;
  font-size: 18px;
  text-align: left;
  z-index: 1;
  background-color: rgba(200,200,200,.9);
  width: 250px;
  display: inline-block;
  border-radius: 5px;
  overflow: auto; 
}

</style>

<style>
.buttons {
  position: absolute;
  top: 550px;
}
</style>


</head>

<body>




<div id="map" class="map">
	
	
	
  <div id="ispis" class="results" >
	<center> <input oninput="updateResult(this.value)" type="search" placeholder="prezime ime" class="inp"/>
	</center>
	<left>
	<ul class="result">
		<li>Prezime Ime rođen-preminuo</li>
	</ul>
  </div>

 <div class="topleftdata" id="podaci"> Podaci o pokojnicima </div> 

</div> 


    <script src="https://cdn.jsdelivr.net/npm/ol@v8.1.0/dist/ol.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.5.0/proj4.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/geotiff@2.0.7/dist-browser/geotiff.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.1.0/ol.css">

</body>



<script>

proj4.defs('EPSG:3765','+proj=tmerc +lat_0=0 +lon_0=16.5 +k=0.9999 +x_0=500000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs');
ol.proj.proj4.register(proj4);
var htrs96 = ol.proj.get('EPSG:3765');


const highlightStyle = new ol.style.Style({
  fill: new ol.style.Fill({
    color: '#eeeeee',
  }),
  stroke: new ol.style.Stroke({
    color: 'rgba(255, 0, 0, 0.7)',
    width: 3,
  }),
});

const standardStyle = new ol.style.Style({
  fill: new ol.style.Fill({
    color: '#eeeeee',
  }),
  stroke: new ol.style.Stroke({
    color: 'rgba(0, 0, 0, 0.7)',
    width: 2,
  }),
});



function siteStyleFunction(feature) {
  return [
  new ol.style.Style({
    stroke: new ol.style.Stroke({
      color: "red",
      width: 3
    }),
    text: new ol.style.Text({
      font: '18px Calibri',
      text: feature.get('Naziv'),
      placement: 'Point',
      offsetX:50,
      fill: new ol.style.Fill({
        color: '#000'
      }),
      stroke: new ol.style.Stroke({
        color: '#fff',
        width: 3
      })
    }),
  })
  ];
}


const osm = new ol.layer.Tile({
  source: new ol.source.OSM(),
});


  
const DOF = new ol.layer.Tile({
            title: 'DOF 2021',
            type: 'base',
            visible: true,
            source: new ol.source.TileWMS({
            url: 'https://geoportal.dgu.hr/services/inspire/orthophoto_2019_2020/wms',
            params: {'LAYERS': 'OI.OrthoimageCoverage', 'TILED': true}          
                    })
           });



var grobnaMjestaIzvor = new ol.source.Vector({
        format: new ol.format.GeoJSON(),
        url: 'https://web-gis-vjezbe.github.io/test/gm_sve_att.geojson'
});

var lokacijeIzvor = new ol.source.Vector({
});


var grobnaMjesta = new ol.layer.Vector({
    source: grobnaMjestaIzvor,
    minResolution: 0.01,
    maxResolution: 5,
    style: standardStyle
});

var lokacijeSloj = new ol.layer.Vector({
    source: lokacijeIzvor,
    minResolution: 5,
    maxResolution: 1000,
    visible: true,
    style: siteStyleFunction
});

const view = new ol.View({
	  projection: htrs96,
          minResolution: 0.01,
          //center: [620000, 5030000],
	  center: [616525, 5024450],
          zoom: 19
});


const map = new ol.Map({
  layers: [ DOF, grobnaMjesta, lokacijeSloj ],
  target: 'map',
  view: view
});



var pokojnici = [];
var lokacije = [];
var zadnjaZnacajka;


fetch('https://web-gis-vjezbe.github.io/test/pok.csv')
//fetch('https://web-gis-vjezbe.github.io/test/pok_combox4.csv')
  .then(
    function(response) {
	response.text().then(function(data) {
		let pokojniciTmp= csvToArray (data)
		pokojnici=pokojniciTmp.map((obj,idx)=> ({ ...obj, id: idx}))
		pokojniciTmp.length=0
      });
    }
  )
  .catch(function(err) {
    console.log('Fetch Error :-S', err);
  });


fetch('https://web-gis-vjezbe.github.io/test/lokacije.csv')
//fetch('https://web-gis-vjezbe.github.io/test/pok_combox4.csv')
  .then(
    function(response) {
	response.text().then(function(data) {
		let lokacije = csvToArray (data)
		drawFeaturesFromArray(lokacije, lokacijeIzvor)
      });
    }
  )
  .catch(function(err) {
    console.log('Fetch Error :-S', err);
  });



const updateResult = query => {
	let resultList = document.querySelector(".result")
	resultList.innerHTML = ""
	var filteri=query.split(" ")
	var results = []

	results=pokojnici.filter(pokojnik =>{
		if (filteri.length<2 && pokojnik.prezime !== undefined) {
			if(pokojnik.prezime.toLowerCase().indexOf(filteri[0].toLowerCase()) != -1 && 
			filteri[0] != "" && 
			filteri[0].length>2){
				return true	
			}
		} else if (pokojnik.prezime !== undefined) {
			if(pokojnik.prezime.toLowerCase().indexOf(filteri[0].toLowerCase()) != -1 && 
			pokojnik.ime.toLowerCase().indexOf(filteri[1].toLowerCase()) != -1 && 
			filteri[0] != "" && 
			filteri[0].length>2){
				return true	
			}

		}
		return false
	})
	if (results.length>0) renderResultPokojnik (results)
}




function renderResultPokojnik (resultIn)  {
	let resultList = document.querySelector(".result")
	resultList.innerHTML = ""
	let tempHTML= ""
	let maxResults = resultIn.length

	for (var i = 0; i < maxResults; i++) {

			// Much faster that writing directly to innerhtml within the loop
			tempHTML += `<li class="list-group-item"> 
						<a href="javascript:void(0)" onclick="zoomTo('${resultIn[i].Foto}')">  
							${resultIn[i].prezime} 
							${resultIn[i].ime} 
							${resultIn[i].rođen} - ${resultIn[i].umro} 
						</a> 
					</li>`	
	}
	resultList.innerHTML +=tempHTML
}





function zoomTo(attVal) {
  
  if (zadnjaZnacajka) zadnjaZnacajka.setStyle (standardStyle)
  zadnjaZnacajka=getFeatureByProperty(grobnaMjestaIzvor, "foto_novi", attVal)

	if (zadnjaZnacajka) {
      		const extent = zadnjaZnacajka.getGeometry().getExtent()
      		view.fit(extent);
		zadnjaZnacajka.setStyle (highlightStyle);

		var podaci=document.getElementById("podaci")

		var attVal=zadnjaZnacajka.get("foto_novi")
		renderFeatureAtts(attVal, 1);
		
	} else { 
		
		podaci.textContent=""	
	}
  return false
}


const clickFeatureInfo = new ol.interaction.Select();
clickFeatureInfo.on('select',function(evt){	

	var podaci=document.getElementById("podaci")

	if (clickFeatureInfo.getFeatures().getArray().length!=0) {
		
		var attVal=clickFeatureInfo.getFeatures().getArray()[0].get("foto_novi")
		renderFeatureAtts(attVal, 1)	
	} else { 
		podaci.textContent=""	
	}
	
})

	map.addInteraction(clickFeatureInfo);
	clickFeatureInfo.setActive (true);


function renderFeatureAtts(attVal, modeIn) {

	let rezultati= pokojnici.filter(x => x.Foto==attVal)
	if (rezultati.length>0) {

		var podaci=document.getElementById("podaci");
		podaci.textContent=""
        	//podaci.appendChild(document.createElement("br"));
		for (var i = 0; i < rezultati.length; i++) {
			podaci.appendChild(document.createTextNode(rezultati[i].ime +" " + 
									rezultati[i].prezime +" " + 
									rezultati[i].rođen +"-" + 
									rezultati[i].umro)
									);
			podaci.appendChild(document.createElement("br"))
		}
	} else podaci.textContent=""			
}




function getFeatureByProperty(sourceIn, propertyIn, valueIn) {

	var features = sourceIn.getFeatures();
	var found=false;
	for (var i = 0, ii = features.length; i < ii; i++) {
  		if (features[i].get(propertyIn) === valueIn) {
    			found = features[i];
    			break;
  		}
	}
	return found;
}


function csvToArray(str, delimiter = ";") {
  
  const headers = str.slice(0, str.indexOf("\r\n")).split(delimiter);
  const rows = str.slice(str.indexOf("\r\n") + 1).split("\r\n");
  const arr = rows.map(function (row) {
    const values = row.split(delimiter);
    const el = headers.reduce(function (object, header, index) {
      object[header] = values[index];
      return object;
    }, {});
    return el;
  });

  // return the array
  return arr;
}



function drawFeaturesFromArray(arrIn, sourceIn) {
console.log (arrIn)
	for (var i = 0; i < arrIn.length; i++) {
		const centar = [parseInt(arrIn[i].centarx), parseInt(arrIn[i].centary)]
		var ftGeom = new ol.geom.Circle(centar,parseInt(arrIn[i].polumjer));
		var locFeat= new ol.Feature({geometry: ftGeom});
		locFeat.setId(arrIn[i].id);
		locFeat.set("Naziv", arrIn[i].naziv);
		sourceIn.addFeature(locFeat);
	}
}



</script>
</html>
